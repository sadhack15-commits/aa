name: üöÄ SEVER AI STV PREMIUM + ULTRAVIEWER

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER CH√ÄO M·ª™NG
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ AI STV PREMIUM RDP + ULTRAVIEWER SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Hi·ªáu ·ª©ng loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!                    " -ForegroundColor Green

      # C·∫§U H√åNH N√ÇNG CAO
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="B·∫≠t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="M·ªü port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # T·∫†O USER PREMIUM
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "‚îÇ ‚ÑπÔ∏è  D√πng m·∫≠t kh·∫©u t√πy ch·ªânh t·ª´ env" -ForegroundColor Blue
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          try {
              Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ ƒê√£ x√≥a user c≈©" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ÑπÔ∏è  Kh√¥ng c√≥ user c≈© ƒë·ªÉ x√≥a" -ForegroundColor Blue
          }
          
          try {
              New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
              Write-Host "‚îÇ ‚úÖ ƒê√£ t·∫°o user m·ªõi" -ForegroundColor Green
              
              try {
                  Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              } catch {}

              Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              
              Enable-LocalUser -Name "AISTV-PREMIUM"
              
              Write-Host "‚îÇ ‚úÖ ƒê√£ c·∫•p quy·ªÅn Administrator & RDP" -ForegroundColor Green
              
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói t·∫°o user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "‚úÖ T√†i kho·∫£n: AISTV-PREMIUM ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # C√ÄI ƒê·∫∂T ULTRAVIEWER
      - name: üì∫ C√ÄI ƒê·∫∂T ULTRAVIEWER
        run: |
          Write-Host ""
          Write-Host "üì∫ ƒêANG C√ÄI ƒê·∫∂T ULTRAVIEWER" -ForegroundColor Yellow
          
          try {
              # Download UltraViewer
              $uvPath = "$env:TEMP\UltraViewer_setup.exe"
              Write-Host "‚îÇ üì• ƒêang t·∫£i UltraViewer..." -ForegroundColor Blue
              Invoke-WebRequest -Uri "https://dl.ultraviewer.net/UltraViewer_setup_6.6_vi.exe" -OutFile $uvPath -ErrorAction Stop
              
              # C√†i ƒë·∫∑t silent mode
              Write-Host "‚îÇ üîß ƒêang c√†i ƒë·∫∑t UltraViewer..." -ForegroundColor Blue
              Start-Process -FilePath $uvPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait -NoNewWindow
              
              # Ch·ªù c√†i ƒë·∫∑t ho√†n t·∫•t
              Start-Sleep -Seconds 10
              
              # Ki·ªÉm tra c√†i ƒë·∫∑t
              $uvExe = "C:\Program Files (x86)\UltraViewer\UltraViewer_Desktop.exe"
              if (Test-Path $uvExe) {
                  Write-Host "‚îÇ ‚úÖ UltraViewer ƒë√£ c√†i ƒë·∫∑t th√†nh c√¥ng" -ForegroundColor Green
                  
                  # Kh·ªüi ƒë·ªông UltraViewer
                  Write-Host "‚îÇ üöÄ ƒêang kh·ªüi ƒë·ªông UltraViewer..." -ForegroundColor Blue
                  Start-Process -FilePath $uvExe -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 8
                  
                  # L·∫•y ID v√† Password t·ª´ registry ho·∫∑c file config
                  try {
                      # ƒê·ªçc ID t·ª´ registry
                      $uvId = (Get-ItemProperty -Path "HKLM:\SOFTWARE\UltraViewer" -Name "ID" -ErrorAction SilentlyContinue).ID
                      if (-not $uvId) {
                          $uvId = (Get-ItemProperty -Path "HKCU:\SOFTWARE\UltraViewer" -Name "ID" -ErrorAction SilentlyContinue).ID
                      }
                      
                      # ƒê·ªçc Password t·ª´ registry
                      $uvPass = (Get-ItemProperty -Path "HKLM:\SOFTWARE\UltraViewer" -Name "Password" -ErrorAction SilentlyContinue).Password
                      if (-not $uvPass) {
                          $uvPass = (Get-ItemProperty -Path "HKCU:\SOFTWARE\UltraViewer" -Name "Password" -ErrorAction SilentlyContinue).Password
                      }
                      
                      if ($uvId) {
                          Write-Host "‚îÇ üîë UltraViewer ID: $uvId" -ForegroundColor Green
                          echo "UV_ID=$uvId" >> $env:GITHUB_ENV
                      } else {
                          Write-Host "‚îÇ ‚ö†Ô∏è  Ch∆∞a l·∫•y ƒë∆∞·ª£c ID (c·∫ßn v√†i gi√¢y kh·ªüi ƒë·ªông)" -ForegroundColor Yellow
                          echo "UV_ID=ƒêang kh·ªüi ƒë·ªông..." >> $env:GITHUB_ENV
                      }
                      
                      if ($uvPass) {
                          Write-Host "‚îÇ üîê UltraViewer Password: $uvPass" -ForegroundColor Green
                          echo "UV_PASS=$uvPass" >> $env:GITHUB_ENV
                      } else {
                          Write-Host "‚îÇ ‚ö†Ô∏è  Ch∆∞a l·∫•y ƒë∆∞·ª£c Password (c·∫ßn v√†i gi√¢y kh·ªüi ƒë·ªông)" -ForegroundColor Yellow
                          echo "UV_PASS=ƒêang kh·ªüi ƒë·ªông..." >> $env:GITHUB_ENV
                      }
                      
                  } catch {
                      Write-Host "‚îÇ ‚ö†Ô∏è  L·ªói ƒë·ªçc th√¥ng tin: $($_.Exception.Message)" -ForegroundColor Yellow
                      echo "UV_ID=Ki·ªÉm tra trong ·ª©ng d·ª•ng" >> $env:GITHUB_ENV
                      echo "UV_PASS=Ki·ªÉm tra trong ·ª©ng d·ª•ng" >> $env:GITHUB_ENV
                  }
                  
              } else {
                  Write-Host "‚îÇ ‚ùå Kh√¥ng t√¨m th·∫•y UltraViewer sau khi c√†i" -ForegroundColor Red
                  echo "UV_ID=C√†i ƒë·∫∑t th·∫•t b·∫°i" >> $env:GITHUB_ENV
                  echo "UV_PASS=N/A" >> $env:GITHUB_ENV
              }
              
              # D·ªçn d·∫πp file c√†i ƒë·∫∑t
              Remove-Item $uvPath -Force -ErrorAction SilentlyContinue
              
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói c√†i ƒë·∫∑t UltraViewer: $($_.Exception.Message)" -ForegroundColor Red
              echo "UV_ID=L·ªói c√†i ƒë·∫∑t" >> $env:GITHUB_ENV
              echo "UV_PASS=N/A" >> $env:GITHUB_ENV
          }

      # TAILSCALE PREMIUM
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow
          
          try {
              $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ C√†i ƒë·∫∑t Tailscale th√†nh c√¥ng" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói c√†i ƒë·∫∑t Tailscale" -ForegroundColor Red
          }
          
          Start-Sleep -Seconds 10
          
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
              Write-Host "‚îÇ ‚úÖ K·∫øt n·ªëi Tailscale th√†nh c√¥ng" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói k·∫øt n·ªëi Tailscale" -ForegroundColor Red
          }
          
          Write-Host "üîÑ ƒêang l·∫•y ƒë·ªãa ch·ªâ IP..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      Write-Host "`r‚úÖ ƒê·ªãa ch·ªâ IP: $ip" -ForegroundColor Green
                      break
                  }
              } catch {}
              Write-Host "`rüîÑ ƒêang l·∫•y ƒë·ªãa ch·ªâ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "`r‚ö†Ô∏è  Kh√¥ng th·ªÉ l·∫•y IP, s·ª≠ d·ª•ng localhost" -ForegroundColor Yellow
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          }

      # L·∫§Y TH√îNG TIN ULTRAVIEWER SAU KHI KH·ªûI ƒê·ªòNG
      - name: üîç L·∫§Y TH√îNG TIN ULTRAVIEWER
        run: |
          Write-Host ""
          Write-Host "üîç ƒêANG L·∫§Y TH√îNG TIN ULTRAVIEWER" -ForegroundColor Yellow
          
          # Ch·ªù UltraViewer kh·ªüi ƒë·ªông ho√†n to√†n
          Start-Sleep -Seconds 15
          
          try {
              # Th·ª≠ nhi·ªÅu ngu·ªìn ƒë·ªÉ l·∫•y ID v√† Password
              $uvId = $null
              $uvPass = $null
              
              # Ngu·ªìn 1: Registry HKLM
              try {
                  $uvId = (Get-ItemProperty -Path "HKLM:\SOFTWARE\UltraViewer" -Name "ID" -ErrorAction SilentlyContinue).ID
                  $uvPass = (Get-ItemProperty -Path "HKLM:\SOFTWARE\UltraViewer" -Name "Password" -ErrorAction SilentlyContinue).Password
              } catch {}
              
              # Ngu·ªìn 2: Registry HKCU
              if (-not $uvId) {
                  try {
                      $uvId = (Get-ItemProperty -Path "HKCU:\SOFTWARE\UltraViewer" -Name "ID" -ErrorAction SilentlyContinue).ID
                      $uvPass = (Get-ItemProperty -Path "HKCU:\SOFTWARE\UltraViewer" -Name "Password" -ErrorAction SilentlyContinue).Password
                  } catch {}
              }
              
              # Ngu·ªìn 3: File config
              if (-not $uvId) {
                  $configPath = "C:\Program Files (x86)\UltraViewer\UltraViewer.ini"
                  if (Test-Path $configPath) {
                      $config = Get-Content $configPath -ErrorAction SilentlyContinue
                      $uvId = ($config | Select-String -Pattern "ID=(.+)" | ForEach-Object { $_.Matches.Groups[1].Value }) -join ""
                      $uvPass = ($config | Select-String -Pattern "Password=(.+)" | ForEach-Object { $_.Matches.Groups[1].Value }) -join ""
                  }
              }
              
              if ($uvId) {
                  Write-Host "‚îÇ ‚úÖ UltraViewer ID: $uvId" -ForegroundColor Green
                  echo "UV_ID=$uvId" >> $env:GITHUB_ENV
              } else {
                  Write-Host "‚îÇ ‚ö†Ô∏è  Kh√¥ng l·∫•y ƒë∆∞·ª£c ID - Vui l√≤ng ki·ªÉm tra trong ·ª©ng d·ª•ng" -ForegroundColor Yellow
                  echo "UV_ID=Xem trong ·ª©ng d·ª•ng UltraViewer" >> $env:GITHUB_ENV
              }
              
              if ($uvPass) {
                  Write-Host "‚îÇ ‚úÖ UltraViewer Password: $uvPass" -ForegroundColor Green
                  echo "UV_PASS=$uvPass" >> $env:GITHUB_ENV
              } else {
                  Write-Host "‚îÇ ‚ö†Ô∏è  Kh√¥ng l·∫•y ƒë∆∞·ª£c Password - Vui l√≤ng ki·ªÉm tra trong ·ª©ng d·ª•ng" -ForegroundColor Yellow
                  echo "UV_PASS=Xem trong ·ª©ng d·ª•ng UltraViewer" >> $env:GITHUB_ENV
              }
              
          } catch {
              Write-Host "‚îÇ ‚ùå L·ªói: $($_.Exception.Message)" -ForegroundColor Red
              echo "UV_ID=L·ªói - Ki·ªÉm tra ·ª©ng d·ª•ng" >> $env:GITHUB_ENV
              echo "UV_PASS=N/A" >> $env:GITHUB_ENV
          }

      # HI·ªÇN TH·ªä TH√îNG TIN ƒê·∫¶Y ƒê·ª¶
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $matKhau) {
              $matKhau = "Kh√¥ng th·ªÉ ƒë·ªçc m·∫≠t kh·∫©u"
          }
          
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 gi·ªù" }
              "3h" { $totalMinutes = 180; $displayTime = "3 gi·ªù" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 gi·ªù 40 ph√∫t" }
          }
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë          üéâ K·∫æT N·ªêI TH√ÄNH C√îNG! üéâ                    ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë                                                       ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  üì∫ ULTRAVIEWER (KHUY√äN D√ôNG - D·ªÑ NH·∫§T!)            ‚ïë" -ForegroundColor Yellow
          Write-Host "‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üîë ID: $env:UV_ID                                ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üîê Pass: $env:UV_PASS                            ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üì• T·∫£i v·ªÅ: https://ultraviewer.net              ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üí° C√°ch d√πng: M·ªü UltraViewer ‚Üí Nh·∫≠p ID & Pass   ‚îÇ ‚ïë" -ForegroundColor Green
          Write-Host "‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚ïë" -ForegroundColor White
          Write-Host "‚ïë                                                       ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  üñ•Ô∏è  REMOTE DESKTOP (Ph∆∞∆°ng √°n d·ª± ph√≤ng)            ‚ïë" -ForegroundColor Yellow
          Write-Host "‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üåê IP: $env:TAILSCALE_IP                        ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üë§ User: AISTV-PREMIUM                          ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üîê Pass: $matKhau                               ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üìç Port: 3389                                   ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚ïë" -ForegroundColor White
          Write-Host "‚ïë                                                       ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  ‚è∞ TH·ªúI GIAN                                        ‚ïë" -ForegroundColor Yellow
          Write-Host "‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üïê B·∫Øt ƒë·∫ßu: $($thoiGianBatDau.ToString('HH:mm:ss'))                         ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ üïê K·∫øt th√∫c: $($thoiGianKetThuc.ToString('HH:mm:ss'))                       ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îÇ ‚è±Ô∏è  Th·ªùi l∆∞·ª£ng: $displayTime                     ‚îÇ ‚ïë" -ForegroundColor White
          Write-Host "‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚ïë" -ForegroundColor White
          Write-Host "‚ïë                                                       ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üöÄ Enjoy your Premium Server! üöÄ" -ForegroundColor Green
          
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # DUY TR√å PHI√äN
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes = $env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "üîÑ B·∫ÆT ƒê·∫¶U DUY TR√å PHI√äN L√ÄM VI·ªÜC..." -ForegroundColor Yellow
          Write-Host "üíé Phi√™n: AI STV PREMIUM + ULTRAVIEWER" -ForegroundColor Magenta
          Write-Host "üîó K·∫øt n·ªëi: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "üì∫ UltraViewer ID: $env:UV_ID" -ForegroundColor Cyan
          Write-Host "üïê B·∫Øt ƒë·∫ßu: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "üïê K·∫øt th√∫c: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host ""
          
          # Monitor script
          $monitorScript = {
              $lastLogTime = Get-Date
              while ($true) {
                  $currentTime = Get-Date
                  
                  if (($currentTime - $lastLogTime).TotalMinutes -ge 2) {
                      $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                      $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                      
                      # Ki·ªÉm tra UltraViewer
                      $uvProcess = Get-Process -Name "UltraViewer_Desktop" -ErrorAction SilentlyContinue
                      $uvStatus = if ($uvProcess) { "Running" } else { "Stopped" }
                      
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üìä RDP: $($termService.Status) | UV: $uvStatus | K·∫øt n·ªëi: $($rdpConnections.Count)" -ForegroundColor Blue
                      $lastLogTime = $currentTime
                      
                      # Kh·ªüi ƒë·ªông l·∫°i UltraViewer n·∫øu b·ªã t·∫Øt
                      if (-not $uvProcess) {
                          try {
                              Start-Process -FilePath "C:\Program Files (x86)\UltraViewer\UltraViewer_Desktop.exe" -ErrorAction SilentlyContinue
                              Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üîÑ ƒê√£ kh·ªüi ƒë·ªông l·∫°i UltraViewer" -ForegroundColor Yellow
                          } catch {}
                      }
                  }
                  
                  $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($termService.Status -ne 'Running') {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] üîÑ Kh·ªüi ƒë·ªông l·∫°i TermService..." -ForegroundColor Yellow
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  Start-Sleep -Seconds 30
              }
          }
          
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"
          
          # Timer
          $frames = @('‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è')
          $colors = @('Red', 'Yellow', 'Green', 'Cyan', 'Blue', 'Magenta')
          $startTime = Get-Date
          
          do {
              $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $thoiGianConLai = $thoiGianKetThuc - $thoiGianHienTai
              
              $gioConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalHours))
              $phutConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalMinutes % 60))
              $giayConLai = [math]::Max(0, [math]::Floor($thoiGianConLai.TotalSeconds % 60))
              
              $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
              $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
              
              Write-Host "`r$frame [$($thoiGianHienTai.ToString('HH:mm:ss'))] Th·ªùi gian c√≤n l·∫°i: $gioConLai gi·ªù $phutConLai ph√∫t $giayConLai gi√¢y" -NoNewline -ForegroundColor $color
              
              Start-Sleep -Seconds 5
              
          } while ($thoiGianConLai.TotalSeconds -gt 0)
          
          Write-Host ""
          Write-Host "üéØ ƒê√É H·∫æT TH·ªúI GIAN - T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red
          
          Get-Job -Name "SystemMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # D·ªåN D·∫∏P CHUY√äN NGHI·ªÜP
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ ƒêANG D·ªåN D·∫∏P H·ªÜ TH·ªêNG..." -ForegroundColor Yellow
          
          $cleanupSteps = @(
              @{Name="ƒê√≥ng UltraViewer"; Script={
                  Stop-Process -Name "UltraViewer_Desktop" -Force -ErrorAction SilentlyContinue
                  Stop-Process -Name "UltraViewer_Service" -Force -ErrorAction SilentlyContinue
              }},
              @{Name="X√≥a file password"; Script={
                  Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
              }},
              @{Name="V√¥ hi·ªáu h√≥a user"; Script={
                  Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              }},
              @{Name="ƒê√≥ng k·∫øt n·ªëi m·∫°ng"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 5
              }},
              @{Name="X√≥a rule firewall"; Script={
                  netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
                  netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
                  Remove-NetFirewallRule -DisplayName "RDP-Premium" -ErrorAction SilentlyContinue
                  Remove-NetFirewallRule -DisplayName "RDP-Premium-Out" -ErrorAction SilentlyContinue
              }},
              @{Name="Kh√¥i ph·ª•c c√†i ƒë·∫∑t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $cleanupSteps) {
              Write-Host "‚îÇ üóëÔ∏è  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ x·ª≠ l√Ω an to√†n" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }
          
          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "üéâ D·ªçn d·∫πp ho√†n t·∫•t! H·∫πn g·∫∑p l·∫°i! üëã" -ForegroundColor Green
